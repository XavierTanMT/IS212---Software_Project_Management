<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Task Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Segoe UI, Arial;
      margin: 0
    }

    .page {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 16px
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      background: #eee;
      border-radius: 999px
    }

    .subtask {
      padding: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center
    }

    .subtask .meta {
      flex: 1
    }

    button {
      padding: 6px 10px
    }

    input[type=text],
    textarea {
      width: 100%;
      padding: 8px;
      margin: 4px 0
    }
  </style>
</head>

<body>
  <div id="nav"></div>
  <div class="page">
    <a href="tasks_list.html">← Back to tasks</a>
    <h1 id="title">Task</h1>
    <div id="taskMeta"></div>
    <h2>Subtasks <small id="subcounts"></small></h2>
    <div id="subtasks"></div>

    <div id="creatorActions" style="margin-top:16px;display:none">
      <h3>Add subtask</h3>
      <div>
        <input id="sub_title" placeholder="Subtask title" />
        <textarea id="sub_description" placeholder="Description (optional)" rows="3"></textarea>
        <input id="sub_due_date" type="date" placeholder="Due date (optional)" />
        <button id="addSub">Add Subtask</button>
      </div>
    </div>
  </div>

  <script src="common.js"></script>
  <script>requireAuth();</script>
  <script>
    const API = API_BASE;
    function q(name) {
      return new URLSearchParams(location.search).get(name);
    }
    const taskId = q('task_id');
    if (!taskId) { document.body.innerHTML = '<div style="padding:20px">Missing task_id</div>'; }

    async function load() {
      const viewer = (getCurrentUser && getCurrentUser()) || {};
      const vid = viewer.user_id || viewer.uid || viewer.id || '';

      // Fetch task
      const res = await fetch(API + '/api/tasks/' + encodeURIComponent(taskId), { headers: vid ? { 'X-User-Id': vid } : {} });
      if (!res.ok) { const e = await res.json().catch(() => ({})); document.getElementById('title').textContent = 'Task not found'; return; }
      const task = await res.json();
      document.getElementById('title').textContent = task.title || 'Task';
      const meta = document.getElementById('taskMeta');
      meta.innerHTML = '';
      meta.innerHTML += '<div><strong>Status:</strong> <span class="pill">' + (task.status || '') + '</span></div>';
      meta.innerHTML += '<div><strong>Priority:</strong> ' + (task.priority || '') + '</div>';
      // Show project name instead of id when possible
      if (task.project_id) {
        try {
          const pRes = await fetch(API + '/api/projects');
          if (pRes.ok) {
            const projects = await pRes.json();
            const proj = (Array.isArray(projects) ? projects : []).find(p => p.project_id === task.project_id) || {};
            meta.innerHTML += '<div><strong>Project:</strong> ' + (proj.name || task.project_id) + '</div>';
          } else {
            meta.innerHTML += '<div><strong>Project:</strong> ' + (task.project_id || '') + '</div>';
          }
        } catch (e) {
          meta.innerHTML += '<div><strong>Project:</strong> ' + (task.project_id || '') + '</div>';
        }
      } else {
        meta.innerHTML += '<div><strong>Project:</strong> ' + (task.project_id || '') + '</div>';
      }
      meta.innerHTML += '<div style="margin-top:8px"><strong>Description</strong><div>' + (task.description || '') + '</div></div>';

      // show counts and percentage (no decimals)
      const total = Number(task.subtask_count || 0);
      const completed = Number(task.subtask_completed_count || 0);
      const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
      document.getElementById('subcounts').textContent = `(${completed}/${total} — ${percent}%)`;

      // show create form only if viewer is creator
      const isCreator = vid && task.created_by && task.created_by.user_id === vid;
      document.getElementById('creatorActions').style.display = isCreator ? 'block' : 'none';

      await loadSubtasks();
    }

    async function loadSubtasks() {
      const viewer = (getCurrentUser && getCurrentUser()) || {};
      const vid = viewer.user_id || viewer.uid || viewer.id || '';
      const res = await fetch(API + '/api/tasks/' + encodeURIComponent(taskId) + '/subtasks', { headers: vid ? { 'X-User-Id': vid } : {} });
      const list = await res.json();
      const host = document.getElementById('subtasks'); host.innerHTML = '';
      if (!res.ok) { host.innerHTML = '<div style="padding:10px;color:red">Failed to load subtasks</div>'; return; }
      if (!Array.isArray(list) || !list.length) { host.innerHTML = '<div style="padding:8px;color:#666">No subtasks</div>'; return; }

      const viewerId = vid;
      const taskCreatorId = (getCurrentUser && getCurrentUser()).user_id; // may be used later

      list.forEach(s => {
        const div = document.createElement('div'); div.className = 'subtask';
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!s.completed;
        cb.style.marginRight = '10px';
        cb.addEventListener('change', async () => {
          try {
            const r = await fetch(API + '/api/tasks/' + encodeURIComponent(taskId) + '/subtasks/' + encodeURIComponent(s.subtask_id) + '/complete', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json', ...(viewerId ? { 'X-User-Id': viewerId } : {}) },
              body: JSON.stringify({ completed: cb.checked })
            });
            if (!r.ok) { alert('Failed to update'); cb.checked = !cb.checked; return; }
            await load();
          } catch (e) { console.error(e); cb.checked = !cb.checked; alert('Network error'); }
        });

        const meta = document.createElement('div'); meta.className = 'meta';
        let metaHtml = '<div style="font-weight:600">' + (s.title || '') + '</div>';
        if (s.description) {
          metaHtml += '<div style="color:#666">' + s.description + '</div>';
        }
        if (s.due_date) {
          metaHtml += '<div style="color:#999;font-size:0.9em">Due: ' + s.due_date + '</div>';
        }
        meta.innerHTML = metaHtml;

        div.appendChild(cb); div.appendChild(meta);

        // If viewer is task creator, show edit/delete
        (async function () {
          const tRes = await fetch(API + '/api/tasks/' + encodeURIComponent(taskId), { headers: vidNow ? { 'X-User-Id': vidNow } : {} });
          const t = await tRes.json().catch(() => ({}));
          const viewerNow = (getCurrentUser && getCurrentUser()) || {};
          const vidNow = viewerNow.user_id || viewerNow.uid || viewerNow.id || '';
          const isCreator = vidNow && t.created_by && t.created_by.user_id === vidNow;
          if (isCreator) {
            const edit = document.createElement('button'); edit.textContent = 'Edit'; edit.style.marginLeft = '8px';
            edit.addEventListener('click', () => {
              const newTitle = prompt('Title', s.title || ''); if (newTitle === null) return;
              const newDesc = prompt('Description', s.description || '');
              fetch(API + '/api/tasks/' + encodeURIComponent(taskId) + '/subtasks/' + encodeURIComponent(s.subtask_id), {
                method: 'PUT', headers: { 'Content-Type': 'application/json', ...(vidNow ? { 'X-User-Id': vidNow } : {}) },
                body: JSON.stringify({ title: newTitle, description: newDesc })
              }).then(r => { if (!r.ok) return r.json().then(js => alert(js.error || 'Failed')); else loadSubtasks(); });
            });
            const del = document.createElement('button'); del.textContent = 'Delete'; del.style.marginLeft = '8px';
            del.addEventListener('click', () => {
              if (!confirm('Delete this subtask?')) return;
              fetch(API + '/api/tasks/' + encodeURIComponent(taskId) + '/subtasks/' + encodeURIComponent(s.subtask_id), {
                method: 'DELETE', headers: { ...(vidNow ? { 'X-User-Id': vidNow } : {}) }
              }).then(async r => { if (!r.ok) { const j = await r.json().catch(() => ({})); alert(j.error || 'Failed'); } else { await load(); } });
            });
            div.appendChild(edit); div.appendChild(del);
          }
        })();

        host.appendChild(div);
      });
    }

    document.getElementById('addSub')?.addEventListener('click', async function () {
      const viewer = (getCurrentUser && getCurrentUser()) || {};
      const vid = viewer.user_id || viewer.uid || viewer.id || '';
      const title = document.getElementById('sub_title').value.trim();
      const description = document.getElementById('sub_description').value.trim();
      const due_date = document.getElementById('sub_due_date').value || null;
      if (!title) { alert('Enter title'); return; }
      try {
        const r = await fetch(API + '/api/tasks/' + encodeURIComponent(taskId) + '/subtasks', {
          method: 'POST', headers: { 'Content-Type': 'application/json', ...(vid ? { 'X-User-Id': vid } : {}) },
          body: JSON.stringify({ title, description, due_date })
        });
        if (!r.ok) { const j = await r.json().catch(() => ({})); alert(j.error || 'Failed'); return; }
        document.getElementById('sub_title').value = '';
        document.getElementById('sub_description').value = '';
        document.getElementById('sub_due_date').value = '';
        await load();
      } catch (e) { console.error(e); alert('Network error'); }
    });

    load();
  </script>
</body>

</html>
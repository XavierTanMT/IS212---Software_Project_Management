<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:0}
    .page{max-width:1000px;margin:20px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:10px}
    input, select{padding:6px}
    table{width:100%;border-collapse:collapse}
    th, td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .pill{display:inline-block;padding:2px 8px;background:#eee;border-radius:999px}
  </style>
</head>
<body>
  <div id="nav"></div>
  <div class="page">
    <h1>Tasks</h1>
    <div class="toolbar">
      <div>
        <label>Archived</label><br/>
        <label><input type="radio" name="archivedToggle" value="hide" id="hideArchived"> Hide Archived</label>
        <label><input type="radio" name="archivedToggle" value="show" id="showArchived"> Show Archived</label>
      </div>
      <div>
        <label>Project</label><br/>
        <select id="project_select"><option value="">(all my tasks)</option></select>
      </div>
      <div>
        <label>Project ID</label><br/>
        <input id="project_id" placeholder="(optional)"/>
      </div>
      <div>
        <label>Assigned To</label><br/>
        <input id="assigned_to_id" placeholder="user id"/>
      </div>
      <div>
        <label>Label ID</label><br/>
        <input id="label_id" placeholder="label id"/>
      </div>
      <div>
        <label>Limit</label><br/>
        <input id="limit" type="number" value="50" min="1" max="200"/>
      </div>
      <div>
        <button id="refresh">Refresh</button>
        <a href="create_task.html">Create Task</a>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Due</th>
          <th>Project</th>
          <th>Assignee</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- Assignment Modal -->
  <div id="assignModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000">
      <div style="background:white; max-width:500px; margin:100px auto; padding:20px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1)">
          <h2 style="margin-top:0">Assign Task to Team Members</h2>
          <div id="assignModalContent">
              <div id="teamMembersList" style="max-height:300px; overflow-y:auto; margin:20px 0; border:1px solid #ddd; border-radius:4px; background:#f9f9f9">
                  <p style="padding:20px; text-align:center; color:#666">Loading team members...</p>
              </div>
              <div style="margin-top:20px">
                  <button onclick="assignSelectedMembers()" style="background:#28a745; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-size:14px">
                      ‚úì Assign Selected
                  </button>
                  <button onclick="closeAssignModal()" style="background:#6c757d; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; margin-left:10px; font-size:14px">
                      Cancel
                  </button>
              </div>
          </div>
      </div>
  </div>

  <script src="common.js"></script>
  <script>requireAuth();</script>
  <script>
  // Cache project id -> name
  const projectMap = Object.create(null);

  const ARCHIVE_PREF_KEY = "tasks_include_archived";
  function paramsFromUI(){
    const p = new URLSearchParams();
    const project_id = document.getElementById("project_id").value.trim();
    const assigned_to_id = document.getElementById("assigned_to_id").value.trim();
    const label_id = document.getElementById("label_id").value.trim();
    const limit = document.getElementById("limit").value.trim();
    const includeArchived = (localStorage.getItem(ARCHIVE_PREF_KEY) === 'true');
    if(project_id) p.set("project_id", project_id);
    if(assigned_to_id) p.set("assigned_to_id", assigned_to_id);
    if(label_id) p.set("label_id", label_id);
    if(limit) p.set("limit", limit);
    if(includeArchived) p.set("include_archived", "true");
    return p.toString();
  }

  function nameForProject(id){
    if(!id) return "";
    return projectMap[id] || id; // fallback to id until map loaded
  }

  // Helper function to format assignees (handles single or multiple)
  function formatAssignees(assigned_to) {
    if (!assigned_to) return "Unassigned";
    
    // Handle array of assignees
    if (Array.isArray(assigned_to)) {
        if (assigned_to.length === 0) return "Unassigned";
        if (assigned_to.length === 1) return assigned_to[0].name || "Unassigned";
        return assigned_to.map(a => a.name).join(", "); // "John, Jane, Bob"
    }
    
    // Handle single assignee object
    return assigned_to.name || "Unassigned";
  }

  async function load(){
    const qs = paramsFromUI();
    const res = await fetch(API_BASE + "/api/tasks" + (qs ? "?" + qs : ""));
    const list = await res.json();
    const tbody = document.getElementById("rows"); tbody.innerHTML = "";
    if(!res.ok){ tbody.innerHTML = "<tr><td colspan='7'>"+ (list.error || "Failed to load") +"</td></tr>"; return; }
    if(!Array.isArray(list) || !list.length){
      tbody.innerHTML = "<tr><td colspan='7'>No tasks</td></tr>";
      return;
    }

    // Check if user is manager
    const user = getCurrentUser();
    const isManager = user && ['manager', 'director', 'hr', 'admin'].includes(user.role);

    list.forEach(t=>{
      const tr = document.createElement("tr");
      const showCompleteBtn = t.status !== 'Completed';
      
      // Create assign button for managers only
      const assignBtn = isManager 
          ? `<button onclick='openAssignModal("${t.task_id}")' style='background:#007bff;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;margin-right:8px' title='Assign to team members'>üë• Assign</button>`
          : '';
      
      tr.innerHTML = ""
        + "<td>" + (t.title || "") + "</td>"
        + "<td><span class='pill'>" + (t.status || "") + "</span></td>"
        + "<td>" + (t.priority || "") + "</td>"
        + "<td>" + (t.due_date || "") + "</td>"
        + "<td>" + nameForProject(t.project_id) + "</td>"
        + "<td>" + formatAssignees(t.assigned_to) + "</td>"
        + "<td>"
        + assignBtn
        + (showCompleteBtn ? "<button onclick='markAsDone(\"" + t.task_id + "\")' style='background:#28a745;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;margin-right:8px'>‚úì Done</button>" : "")
        +   "<a href='edit_task.html?task_id=" + encodeURIComponent(t.task_id) + "'>Edit</a> ¬∑ "
        +   "<a href='task_notes.html?task_id=" + encodeURIComponent(t.task_id) + "'>Notes</a> ¬∑ "
        +   "<a href='attachments.html?task_id=" + encodeURIComponent(t.task_id) + "'>Files</a>"
        + "</td>";
      tbody.appendChild(tr);
    });
  }

  document.getElementById("refresh").addEventListener("click", load);

  // --- archived toggle init ---
  const hideR = document.getElementById("hideArchived");
  const showR = document.getElementById("showArchived");
  const saved = localStorage.getItem(ARCHIVE_PREF_KEY);
  if (saved === 'true'){ showR.checked = true; } else { hideR.checked = true; }
  function onToggle(){
    const on = showR.checked;
    localStorage.setItem(ARCHIVE_PREF_KEY, on ? 'true' : 'false');
    load();
  }
  hideR.addEventListener("change", onToggle);
  showR.addEventListener("change", onToggle);

  async function fillProjects(){
    const res = await fetch(API_BASE + "/api/projects");
    const list = await res.json();
    const sel = document.getElementById("project_select");
    sel.innerHTML = '<option value="">(all my tasks)</option>';
    (Array.isArray(list)?list:[]).forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.project_id; opt.textContent = p.name + " (" + p.project_id + ")";
      sel.appendChild(opt);
      projectMap[p.project_id] = p.name || p.project_id; // populate map
    });
    const cp = getCurrentProject();
    if(cp && cp.project_id){ sel.value = cp.project_id; document.getElementById("project_id").value = cp.project_id; }
    sel.addEventListener("change", ()=>{
      document.getElementById("project_id").value = sel.value;
      load();
    });
  }

  document.addEventListener("DOMContentLoaded", async function(){
    await fillProjects();
    await load();
  });

  // Mark task as done
  async function markAsDone(taskId) {
    if (!confirm('Mark this task as completed?')) return;
    
    try {
      const user = getCurrentUser();
      const response = await fetch(API_BASE + "/api/tasks/" + taskId, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-User-Id': user.user_id
        },
        body: JSON.stringify({ status: 'Completed' })
      });

      const result = await response.json();

      if (response.ok) {
        alert('Task marked as completed!');
        
        // If this was a recurring task, show info about next occurrence
        if (result.next_recurring_task_id) {
          alert('Task completed! Next occurrence has been created.');
        }
        
        // Refresh the task list
        await load();
      } else {
        alert('Failed to complete task: ' + (result.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error marking task as done:', error);
      alert('Network error. Please check your connection and try again.');
    }
  }
  </script>

  <script>
  // Assignment Modal Functions
  let currentAssignTaskId = null;
  let teamMembers = [];

  async function openAssignModal(taskId) {
      currentAssignTaskId = taskId;
      document.getElementById('assignModal').style.display = 'block';
      await loadTeamMembers();
  }

  function closeAssignModal() {
      document.getElementById('assignModal').style.display = 'none';
      currentAssignTaskId = null;
  }

  async function loadTeamMembers() {
      const user = getCurrentUser();
      const listDiv = document.getElementById('teamMembersList');
      
      listDiv.innerHTML = '<p style="padding:20px;text-align:center;color:#666">Loading team members...</p>';
      
      try {
          // ‚úÖ Step 1: Get team members
          const response = await fetch(`${API_BASE}/api/manager/my-team`, {
              headers: { 'X-User-Id': user.user_id }
          });
          
          if (!response.ok) {
              throw new Error('Failed to load team members');
          }
          
          const data = await response.json();
          teamMembers = data.team_staff || [];
          
          if (teamMembers.length === 0) {
              listDiv.innerHTML = '<p style="padding:20px;color:#666;text-align:center">No team members found.<br>Add staff to your team from the <a href="manager_dashboard.html">Manager Dashboard</a>.</p>';
              return;
          }
          
          // ‚úÖ Step 2: Get current task to find existing assignees
          const taskResponse = await fetch(`${API_BASE}/api/tasks/${currentAssignTaskId}`);
          const taskData = await taskResponse.json();
          
          // ‚úÖ Step 3: Extract current assignee IDs
          let currentAssigneeIds = [];
          if (taskData && taskData.assigned_to) {
              if (Array.isArray(taskData.assigned_to)) {
                  // Multiple assignees
                  currentAssigneeIds = taskData.assigned_to.map(a => a.user_id);
              } else {
                  // Single assignee
                  currentAssigneeIds = [taskData.assigned_to.user_id];
              }
          }
          
          // ‚úÖ Step 4: Render checkboxes with current assignees pre-checked and highlighted
          listDiv.innerHTML = teamMembers.map(member => {
              const isCurrentlyAssigned = currentAssigneeIds.includes(member.user_id);
              return `
                  <div style="padding:12px; border-bottom:1px solid #eee; background:${isCurrentlyAssigned ? '#e8f5e9' : 'white'}">
                      <label style="display:flex; align-items:center; cursor:pointer">
                          <input type="checkbox" 
                                 value="${member.user_id}" 
                                 class="team-member-checkbox" 
                                 ${isCurrentlyAssigned ? 'checked' : ''}
                                 style="margin-right:10px; width:18px; height:18px; cursor:pointer">
                          <div style="flex:1">
                              <strong style="font-size:14px">${member.name}</strong>
                              ${isCurrentlyAssigned ? '<span style="color:#4caf50;font-size:12px;margin-left:8px;font-weight:bold">‚úì Currently Assigned</span>' : ''}
                              <br>
                              <small style="color:#666">${member.email}</small>
                          </div>
                      </label>
                  </div>
              `;
          }).join('');
          
      } catch (error) {
          console.error('Error loading team members:', error);
          listDiv.innerHTML = '<p style="padding:20px;color:red;text-align:center">Error loading team members.<br>Please try again.</p>';
      }
  }

  async function assignSelectedMembers() {
      const user = getCurrentUser();
      const selectedIds = Array.from(document.querySelectorAll('.team-member-checkbox:checked'))
          .map(cb => cb.value);
      
      if (selectedIds.length === 0) {
          alert('Please select at least one team member');
          return;
      }
      
      try {
          const response = await fetch(`${API_BASE}/api/manager/tasks/${currentAssignTaskId}/assign`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-User-Id': user.user_id
              },
              body: JSON.stringify({ assignee_ids: selectedIds })
          });
          
          const result = await response.json();
          
          if (response.ok) {
              alert(`‚úÖ Task assigned to ${selectedIds.length} team member(s)`);
              closeAssignModal();
              await load(); // Refresh task list
          } else {
              alert(`‚ùå Error: ${result.error || 'Failed to assign task'}`);
          }
      } catch (error) {
          console.error('Error assigning task:', error);
          alert('‚ùå Network error. Please try again.');
      }
  }

  // Close modal when clicking outside
  document.getElementById('assignModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
          closeAssignModal();
      }
  });
  </script>

  <script>
  // --- PATCH: tasks empty state --- //
  (function(){
    if (window.__tasksPatchApplied) return; window.__tasksPatchApplied = true;
    function afterLoad(){
      const listHost = document.querySelector('#tasksList, .tasks-list, #taskList');
      if (!listHost) return;
      if (listHost.children.length === 0 || listHost.innerHTML.trim() === ''){
        listHost.innerHTML = '<div style="padding:12px;color:#666">No tasks yet. Create your first task.</div>';
      }
      document.querySelectorAll('.loading, .spinner').forEach(el=>el.remove());
    }
    window.addEventListener('load', ()=> setTimeout(afterLoad, 200));
  })();
  </script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="css/common.css">

    <meta charset="UTF-8">
    <title>Admin Dashboard - TaskMgr</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <style>
        body {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        h2 {
            font-size: 1.8rem;
            color: #34495e;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 0.5rem;
        }

        h3 {
            font-size: 1.3rem;
            color: #2c3e50;
            margin: 1.5rem 0 1rem 0;
        }

        h4 {
            font-size: 1.1rem;
            color: #34495e;
            margin: 0.5rem 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            margin: 0 0 15px 0;
            font-size: 0.9rem;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 3rem;
            font-weight: bold;
            line-height: 1;
        }

        .section {
            background: white;
            padding: 30px;
            margin: 25px 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .user-table th,
        .user-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e8ecef;
        }

        .user-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .user-table tbody tr {
            transition: background-color 0.2s;
        }

        .user-table tbody tr:hover {
            background: #f8f9fa;
        }

        .user-table code {
            background: #f1f3f5;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #667eea;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-admin {
            background: #ffe5e5;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .badge-manager {
            background: #e7f3ff;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .badge-director {
            background: #f3e5f5;
            color: #764ba2;
            border: 1px solid #764ba2;
        }

        .badge-hr {
            background: #fce4ec;
            color: #c2185b;
            border: 1px solid #f093fb;
        }

        .badge-staff {
            background: #e0f7fa;
            color: #00838f;
            border: 1px solid #00acc1;
        }

        .badge-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        .badge-inactive {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #6c757d;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 3px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group small {
            color: #666;
            font-size: 12px;
        }

        .message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin: 30px 0 0 0;
            border-bottom: 3px solid #e8ecef;
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 0 10px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s;
            position: relative;
        }

        .tab:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab.active {
            color: #667eea;
            font-weight: 600;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <div id="nav"></div>

    <div
        style="background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <h1>üëë Admin Dashboard</h1>
        <p style="font-size: 1.1rem; color: #6c757d; margin: 10px 0 0 0;">System-wide administration and user management
        </p>
    </div>

    <div class="stats-grid" id="statsGrid">
        <!-- Stats will be loaded here -->
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" id="tab-overview">üìä Overview</button>
        <button class="tab" id="tab-users">üë• User Management</button>
        <button class="tab" id="tab-projects">üìÅ Projects</button>
        <button class="tab" id="tab-reports">üìà Reports & Export</button>
    </div>

    <!-- Tab Content: Overview -->
    <div id="overview-tab" class="tab-content active">
        <div class="section">
            <h2>üìä System Overview</h2>
            <div id="systemOverview">
                <p>Loading system statistics...</p>
            </div>
        </div>
    </div>

    <!-- Tab Content: User Management -->
    <div id="users-tab" class="tab-content">
        <div class="section">
            <h2>üë• User Management</h2>
            <p style="color: #6c757d; margin-bottom: 25px; font-size: 1.05rem;">Create, manage, and filter user accounts
                across the organization</p>

            <div
                style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                <button class="btn btn-success" id="createUserBtn" style="font-size: 15px; padding: 12px 24px;">‚ûï Create
                    New User</button>
                <div style="flex: 1; min-width: 200px;">
                    <label
                        style="display: block; font-size: 0.85rem; color: #6c757d; margin-bottom: 5px; font-weight: 600;">Filter
                        by Role:</label>
                    <select id="roleFilter"
                        style="width: 100%; padding: 12px 15px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px; background: white;">
                        <option value="">All Roles</option>
                        <option value="staff">Staff</option>
                        <option value="manager">Manager</option>
                        <option value="director">Director</option>
                        <option value="hr">HR</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label
                        style="display: block; font-size: 0.85rem; color: #6c757d; margin-bottom: 5px; font-weight: 600;">Filter
                        by Status:</label>
                    <select id="statusFilter"
                        style="width: 100%; padding: 12px 15px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px; background: white;">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <table class="user-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>User ID</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="8">Loading users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab Content: Projects -->
    <div id="projects-tab" class="tab-content">
        <div class="section">
            <h2>üìÅ All Projects</h2>
            <div id="projectsList">Loading projects...</div>
        </div>
    </div>

    <!-- Tab Content: Reports & Export -->
    <div id="reports-tab" class="tab-content">
        <div class="section">
            <h2>üìà Reports & Export</h2>
            <p style="color: #6c757d; margin-bottom: 30px; font-size: 1.05rem;">Generate on-demand reports in PDF, CSV,
                or Excel format. Available to HR/Admin only.</p>

            <div
                style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 30px; border-radius: 12px; margin: 25px 0; border-left: 4px solid #667eea; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                <h3 style="margin-top: 0; color: #667eea; font-size: 1.5rem;">üìã Task Completion Report</h3>
                <p style="color: #5a6c7d; font-size: 1.05rem; margin-bottom: 25px;">Generate comprehensive task
                    completion reports with customizable filters</p>

                <!-- Report Configuration Section -->
                <div
                    style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                    <h4 style="margin-top: 0; color: #2c3e50; font-size: 1.1rem; margin-bottom: 20px;">‚öôÔ∏è Report
                        Configuration</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <!-- Report Type -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="reportType"
                                style="font-size: 0.9rem; color: #495057; margin-bottom: 8px;">Report Type:</label>
                            <select id="reportType" class="form-control"
                                style="padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 15px; background: #f8f9fa;">
                                <option value="summary">Summary Report</option>
                                <option value="user">By User</option>
                                <option value="project">By Project</option>
                            </select>
                        </div>

                        <!-- Format -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="reportFormat"
                                style="font-size: 0.9rem; color: #495057; margin-bottom: 8px;">Export Format:</label>
                            <select id="reportFormat" class="form-control"
                                style="padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 15px; background: #f8f9fa;">
                                <option value="pdf">üìÑ PDF</option>
                                <option value="csv">üìä CSV</option>
                                <option value="xlsx">üìó Excel (XLSX)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div
                    style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                    <h4 style="margin-top: 0; color: #2c3e50; font-size: 1.1rem; margin-bottom: 20px;">üîç Filters
                        (Optional)</h4>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <!-- User Filter -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filterUserId"
                                style="font-size: 0.9rem; color: #495057; margin-bottom: 8px;">Filter by User:</label>
                            <input type="text" id="filterUserId" placeholder="Enter user_id" class="form-control"
                                style="padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 15px;">
                            <small style="color: #6c757d; font-size: 0.85rem; margin-top: 5px; display: block;">Leave
                                blank for all users</small>
                        </div>

                        <!-- Project Filter -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filterProjectId"
                                style="font-size: 0.9rem; color: #495057; margin-bottom: 8px;">Filter by
                                Project:</label>
                            <input type="text" id="filterProjectId" placeholder="Enter project_id" class="form-control"
                                style="padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 15px;">
                            <small style="color: #6c757d; font-size: 0.85rem; margin-top: 5px; display: block;">Leave
                                blank for all projects</small>
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="startDate" style="font-size: 0.9rem; color: #495057; margin-bottom: 8px;">Start
                                Date (Due Date):</label>
                            <input type="date" id="startDate" class="form-control"
                                style="padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 15px;">
                            <small style="color: #6c757d; font-size: 0.85rem; margin-top: 5px; display: block;">Filter
                                tasks due on or after this date</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="endDate" style="font-size: 0.9rem; color: #495057; margin-bottom: 8px;">End Date
                                (Due Date):</label>
                            <input type="date" id="endDate" class="form-control"
                                style="padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 15px;">
                            <small style="color: #6c757d; font-size: 0.85rem; margin-top: 5px; display: block;">Filter
                                tasks due on or before this date</small>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="generateReportBtn"
                    style="width: 100%; padding: 18px; font-size: 17px; font-weight: 600; margin-top: 0; box-shadow: 0 3px 8px rgba(102,126,234,0.25);">
                    üì• Generate & Download Report
                </button>

                <div id="reportMessage" style="margin-top: 20px;"></div>
            </div>

            <!-- Quick Report Options -->
            <div
                style="background: white; padding: 30px; border-radius: 12px; margin-top: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <h3 style="margin-top: 0; color: #2c3e50; font-size: 1.4rem; margin-bottom: 10px;">‚ö° Quick Reports</h3>
                <p style="color: #6c757d; font-size: 1.05rem; margin-bottom: 25px;">Generate common reports with one
                    click - no configuration needed</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                    <button class="btn btn-success" onclick="quickReport('this_week')"
                        style="padding: 16px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üìÖ</span> <span>This Week's Tasks</span>
                    </button>
                    <button class="btn btn-success" onclick="quickReport('this_month')"
                        style="padding: 16px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üìÜ</span> <span>This Month's Tasks</span>
                    </button>
                    <button class="btn btn-success" onclick="quickReport('completed')"
                        style="padding: 16px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>‚úÖ</span> <span>All Completed Tasks</span>
                    </button>
                    <button class="btn btn-success" onclick="quickReport('overdue')"
                        style="padding: 16px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>‚ö†Ô∏è</span> <span>Overdue Tasks</span>
                    </button>
                </div>
            </div>

            <!-- Report Tips -->
            <div
                style="margin-top: 25px; padding: 25px; background: linear-gradient(135deg, #fff8dc 0%, #fffacd 100%); border-radius: 12px; border-left: 4px solid #ffc107; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                <h4 style="margin-top: 0; color: #856404; font-size: 1.2rem; margin-bottom: 15px;">üí° Report Tips & Best
                    Practices</h4>
                <div style="display: grid; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.7); padding: 12px 15px; border-radius: 6px;">
                        <strong style="color: #2c3e50;">üìÑ PDF:</strong> <span style="color: #5a6c7d;">Best for
                            presentations and formal reports (limited to 50 tasks)</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.7); padding: 12px 15px; border-radius: 6px;">
                        <strong style="color: #2c3e50;">üìä CSV:</strong> <span style="color: #5a6c7d;">Best for quick
                            data analysis and spreadsheet import</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.7); padding: 12px 15px; border-radius: 6px;">
                        <strong style="color: #2c3e50;">üìó Excel (XLSX):</strong> <span style="color: #5a6c7d;">Best for
                            detailed analysis with formatted tables</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.7); padding: 12px 15px; border-radius: 6px;">
                        <strong style="color: #2c3e50;">üìÖ Date filters:</strong> <span style="color: #5a6c7d;">Use due
                            date range to focus on specific periods</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.7); padding: 12px 15px; border-radius: 6px;">
                        <strong style="color: #2c3e50;">üîç Filters:</strong> <span style="color: #5a6c7d;">Combine user
                            and project filters for targeted reports</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">&times;</span>
            <h2>‚ûï Create New User</h2>

            <form id="createUserForm">
                <div class="form-group">
                    <label for="user_id">User ID:</label>
                    <input type="text" id="user_id" required placeholder="unique-user-id">
                    <small>Unique identifier (e.g., emp001, john_doe)</small>
                </div>

                <div class="form-group">
                    <label for="name">Full Name:</label>
                    <input type="text" id="name" required placeholder="John Doe">
                </div>

                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required placeholder="user@example.com">
                    <small>User will use this email to log in</small>
                </div>

                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required placeholder="At least 6 characters" minlength="6">
                    <small>Minimum 6 characters - share this with the user securely</small>
                </div>

                <div class="form-group">
                    <label for="role">Role:</label>
                    <select id="role" required>
                        <option value="staff">Staff</option>
                        <option value="manager">Manager</option>
                        <option value="director">Director</option>
                        <option value="hr">HR</option>
                        <option value="admin">Admin</option>
                    </select>
                    <small>Determines user permissions and dashboard access</small>
                </div>

                <div class="form-group">
                    <label for="department">Department:</label>
                    <select id="department">
                        <option value="">-- Select Department --</option>
                        <option value="Finance &amp; Accounting">Finance &amp; Accounting</option>
                        <option value="Operations">Operations</option>
                        <option value="Customer Service (Support)">Customer Service (Support)</option>
                        <option value="Sales &amp; Marketing">Sales &amp; Marketing</option>
                        <option value="Product Management">Product Management</option>
                        <option value="Quality Assurance (QA)">Quality Assurance (QA)</option>
                        <option value="IT / Data / Infrastructure">IT / Data / Infrastructure</option>
                        <option value="Legal &amp; Compliance">Legal &amp; Compliance</option>
                    </select>
                    <small>Optional: assign a department to the user</small>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 10px;">
                    Create User
                </button>

                <div id="createUserMessage"></div>
            </form>
        </div>
    </div>

    <!-- ‚úÖ Load firebase-auth.js FIRST (it defines API_BASE) -->
    <script src="firebase-auth.js"></script>

    <script>
        // ‚úÖ Require admin role
        const currentUser = requireAdmin();

        // ‚úÖ DON'T redeclare API_BASE - it's already in firebase-auth.js
        // const API_BASE = 'http://localhost:5000'; // ‚ùå REMOVED

        let allUsers = [];

        // ==================== TAB SWITCHING (Event Listeners) ====================

        document.getElementById('tab-overview').addEventListener('click', function () {
            switchTab('overview', this);
        });

        document.getElementById('tab-users').addEventListener('click', function () {
            switchTab('users', this);
        });

        document.getElementById('tab-projects').addEventListener('click', function () {
            switchTab('projects', this);
        });

        document.getElementById('tab-reports').addEventListener('click', function () {
            switchTab('reports', this);
        });

        function switchTab(tabName, tabElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            tabElement.classList.add('active');

            // Load data for tab
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'projects') {
                loadProjects();
            }
        }

        // ==================== DASHBOARD LOADING ====================

        async function loadAdminDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`);
                const data = await response.json();

                // Load statistics
                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="number">${data.statistics.total_users}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users</h3>
                        <div class="number">${data.statistics.active_users}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Tasks</h3>
                        <div class="number">${data.statistics.total_tasks}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Projects</h3>
                        <div class="number">${data.statistics.total_projects}</div>
                    </div>
                `;
                document.getElementById('statsGrid').innerHTML = statsHtml;

                // Load system overview
                const overviewHtml = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0;">üë• Users by Role</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; border-left: 4px solid #00acc1;">
                                <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">Staff</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #00838f;">${data.statistics.users_by_role.staff || 0}</div>
                            </div>
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">Managers</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #667eea;">${data.statistics.users_by_role.manager || 0}</div>
                            </div>
                            <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #764ba2;">
                                <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">Directors</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #764ba2;">${data.statistics.users_by_role.director || 0}</div>
                            </div>
                            <div style="background: #fce4ec; padding: 15px; border-radius: 8px; border-left: 4px solid #c2185b;">
                                <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">HR</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #c2185b;">${data.statistics.users_by_role.hr || 0}</div>
                            </div>
                            <div style="background: #ffe5e5; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                                <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">Admins</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #dc3545;">${data.statistics.users_by_role.admin || 0}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fff8e1; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h3 style="margin-top: 0; color: #f39c12;">üìä Recent Activity</h3>
                        <p style="font-size: 1.1rem; margin: 10px 0;"><strong>Tasks created today:</strong> <span style="font-size: 1.5rem; color: #f39c12; font-weight: bold;">${data.statistics.tasks_created_today || 0}</span></p>
                    </div>
                `;
                document.getElementById('systemOverview').innerHTML = overviewHtml;

                // Store users for filtering
                allUsers = data.recent_users || [];
                displayUsers(allUsers);

            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                alert('Failed to load admin dashboard');
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`);
                const data = await response.json();
                allUsers = data.recent_users || [];
                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td><code>${user.user_id || 'N/A'}</code></td>
                    <td>${user.department || 'N/A'}</td>
                    <td><span class="badge badge-${user.role || 'staff'}">${(user.role || 'staff').toUpperCase()}</span></td>
                    <td><span class="badge badge-${user.is_active !== false ? 'active' : 'inactive'}">${user.is_active !== false ? 'Active' : 'Inactive'}</span></td>
                    <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="changeUserRole('${user.user_id}')">Change Role</button>
                        <button class="btn btn-primary" onclick="changeUserDepartment('${user.user_id}')">Set Dept</button>
                        ${user.is_active !== false ?
                    `<button class="btn btn-danger" onclick="deactivateUser('${user.user_id}')">Deactivate</button>` :
                    `<button class="btn btn-success" onclick="activateUser('${user.user_id}')">Activate</button>`
                }
                    </td>
                </tr>
            `).join('');
        }

        // ==================== USER FILTERING ====================

        document.getElementById('roleFilter').addEventListener('change', filterUsers);
        document.getElementById('statusFilter').addEventListener('change', filterUsers);

        function filterUsers() {
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = allUsers;

            if (roleFilter) {
                filtered = filtered.filter(u => u.role === roleFilter);
            }

            if (statusFilter === 'active') {
                filtered = filtered.filter(u => u.is_active !== false);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(u => u.is_active === false);
            }

            displayUsers(filtered);
        }

        // ==================== CREATE USER MODAL ====================

        document.getElementById('createUserBtn').addEventListener('click', openCreateUserModal);
        document.getElementById('closeModalBtn').addEventListener('click', closeCreateUserModal);

        function openCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserMessage').innerHTML = '';
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('createUserModal');
            if (event.target == modal) {
                closeCreateUserModal();
            }
        }

        // ==================== CREATE USER HANDLER ====================

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const messageDiv = document.getElementById('createUserMessage');
            messageDiv.innerHTML = '<p>Creating user...</p>';

            const userData = {
                user_id: document.getElementById('user_id').value.trim(),
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                manager_type: document.getElementById('role').value,  // For backend compatibility
                department: document.getElementById('department').value || ''
            };

            try {
                // Determine endpoint based on role
                const endpoint = userData.role === 'staff' ? 'staff' : 'managers';

                const response = await fetch(`${API_BASE}/api/admin/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = `
                        <div class="message success">
                            <p><strong>‚úÖ User Created Successfully!</strong></p>
                            <p>Send these credentials to the user:</p>
                            <p><strong>Email:</strong> ${result.user.email}</p>
                            <p><strong>Password:</strong> ${userData.password}</p>
                            <p><strong>Role:</strong> ${result.user.role}</p>
                            <p><strong>Department:</strong> ${result.user.department || userData.department || 'N/A'}</p>
                            <p><strong>Login URL:</strong> <a href="login.html" target="_blank">login.html</a></p>
                        </div>
                    `;

                    // Reload users list
                    setTimeout(() => {
                        loadUsers();
                        closeCreateUserModal();
                    }, 3000);

                } else {
                    messageDiv.innerHTML = `<div class="message error">‚ùå ${result.error}</div>`;
                }

            } catch (error) {
                messageDiv.innerHTML = `<div class="message error">‚ùå Error: ${error.message}</div>`;
            }
        });

        // ==================== USER MANAGEMENT ACTIONS ====================

        async function changeUserRole(userId) {
            const newRole = prompt('Enter new role (staff, manager, director, hr, admin):');
            if (!newRole) return;

            const validRoles = ['staff', 'manager', 'director', 'hr', 'admin'];
            if (!validRoles.includes(newRole)) {
                alert('Invalid role. Must be: staff, manager, director, hr, or admin');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });

                if (response.ok) {
                    alert('Role updated successfully');
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('Failed: ' + error.error);
                }
            } catch (error) {
                alert('Error updating role');
            }
        }

        async function deactivateUser(userId) {
            if (!confirm('Deactivate this user? They will not be able to log in.')) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: false })
                });

                if (response.ok) {
                    alert('User deactivated');
                    loadUsers();
                } else {
                    alert('Failed to deactivate user');
                }
            } catch (error) {
                alert('Error deactivating user');
            }
        }

        async function activateUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: true })
                });

                if (response.ok) {
                    alert('User activated');
                    loadUsers();
                } else {
                    alert('Failed to activate user');
                }
            } catch (error) {
                alert('Error activating user');
            }
        }

        // ==================== PROJECTS ====================

        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const projects = await response.json();

                const projectsHtml = projects.map(p => `
                    <div style="padding: 20px; border: 2px solid #e8ecef; margin: 15px 0; border-radius: 10px; background: #ffffff; transition: all 0.2s;" onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.1)'" onmouseout="this.style.borderColor='#e8ecef'; this.style.boxShadow='none'">
                        <h3 style="color: #667eea; margin-top: 0; font-size: 1.3rem;">${p.name || p.project_id}</h3>
                        <p style="color: #5a6c7d; line-height: 1.6; margin: 12px 0;">${p.description || 'No description'}</p>
                        <p style="margin: 10px 0;"><strong style="color: #2c3e50;">Project ID:</strong> <code style="background: #f1f3f5; padding: 4px 8px; border-radius: 4px; color: #667eea; font-size: 0.85rem;">${p.project_id}</code></p>
                        <p style="margin: 10px 0; color: #6c757d;"><strong>Created:</strong> ${p.created_at ? new Date(p.created_at).toLocaleDateString() : 'N/A'}</p>
                    </div>
                `).join('');

                document.getElementById('projectsList').innerHTML = projectsHtml || 'No projects found';
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projectsList').innerHTML = 'Error loading projects';
            }
        }

        // ==================== PAGE INITIALIZATION ====================

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadAdminDashboard);

        // ==================== REPORTS & EXPORT ====================

        document.getElementById('generateReportBtn').addEventListener('click', generateReport);

        async function generateReport() {
            const messageDiv = document.getElementById('reportMessage');
            messageDiv.innerHTML = '<div class="message info">‚è≥ Generating report...</div>';

            const reportType = document.getElementById('reportType').value;
            const format = document.getElementById('reportFormat').value;
            const userId = document.getElementById('filterUserId').value.trim();
            const projectId = document.getElementById('filterProjectId').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Build query parameters
            const params = new URLSearchParams({
                format: format,
                report_type: reportType
            });

            if (userId) params.append('user_id', userId);
            if (projectId) params.append('project_id', projectId);
            if (startDate) params.append('start_date', startDate + 'T00:00:00Z');
            if (endDate) params.append('end_date', endDate + 'T23:59:59Z');

            try {
                const response = await fetch(`${API_BASE}/api/reports/task-completion?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'X-User-Id': currentUser.uid
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    messageDiv.innerHTML = `<div class="message error">‚ùå ${error.error || 'Failed to generate report'}</div>`;
                    return;
                }

                // Get filename from Content-Disposition header or create default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `task_report_${new Date().getTime()}.${format}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) filename = filenameMatch[1];
                }

                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                messageDiv.innerHTML = `<div class="message success">‚úÖ Report downloaded successfully: ${filename}</div>`;

            } catch (error) {
                console.error('Error generating report:', error);
                messageDiv.innerHTML = `<div class="message error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Quick report functions
        function quickReport(type) {
            const messageDiv = document.getElementById('reportMessage');
            const today = new Date();
            let startDate = '';
            let endDate = '';

            // Calculate date ranges
            switch (type) {
                case 'this_week':
                    const monday = new Date(today);
                    monday.setDate(today.getDate() - today.getDay() + 1);
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);
                    startDate = monday.toISOString().split('T')[0];
                    endDate = sunday.toISOString().split('T')[0];
                    break;

                case 'this_month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;

                case 'completed':
                    // Leave dates blank, will show all completed
                    break;

                case 'overdue':
                    // Tasks due before today
                    endDate = new Date(today.setDate(today.getDate() - 1)).toISOString().split('T')[0];
                    break;
            }

            // Set form values
            document.getElementById('startDate').value = startDate;
            document.getElementById('endDate').value = endDate;
            document.getElementById('reportType').value = 'summary';
            document.getElementById('reportFormat').value = 'pdf';
            document.getElementById('filterUserId').value = '';
            document.getElementById('filterProjectId').value = '';

            // Show message
            messageDiv.innerHTML = `<div class="message info">üìã Quick report configured for: <strong>${type.replace('_', ' ')}</strong>. Click "Generate & Download Report" to export.</div>`;
        }

        // ==================== CHANGE DEPARTMENT ====================

        async function changeUserDepartment(userId) {
            // Allowed departments - must match backend
            const departments = [
                'Finance & Accounting',
                'Operations',
                'Customer Service (Support)',
                'Sales & Marketing',
                'Product Management',
                'Quality Assurance (QA)',
                'IT / Data / Infrastructure',
                'Legal & Compliance'
            ];

            // Show a prompt with options (admin must type exact value)
            const list = departments.map(d => `- ${d}`).join('\n');
            let newDept = prompt(`Enter new department for user ${userId}:\n(Enter empty to clear)\n\nAvailable departments:\n${list}`);
            if (newDept === null) return; // cancelled

            newDept = newDept.trim();

            if (newDept !== '' && !departments.includes(newDept)) {
                alert('Invalid department. Please enter one of the listed departments exactly.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/department`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-User-Id': currentUser.uid },
                    body: JSON.stringify({ department: newDept })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Department updated successfully');
                    loadUsers();
                } else {
                    alert('Failed to update department: ' + (result.error || JSON.stringify(result)));
                }
            } catch (err) {
                console.error('Error updating department:', err);
                alert('Error updating department');
            }
        }
    </script>
</body>

</html>
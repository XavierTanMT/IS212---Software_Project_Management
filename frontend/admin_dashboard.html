<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - TaskMgr</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <style>
        body { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 14px; opacity: 0.9; }
        .stat-card .number { font-size: 32px; font-weight: bold; }
        .section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .user-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .user-table th, .user-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        .user-table th { background: #f5f5f5; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-admin { background: #dc3545; color: white; }
        .badge-manager { background: #667eea; color: white; }
        .badge-director { background: #764ba2; color: white; }
        .badge-hr { background: #f093fb; color: white; }
        .badge-staff { background: #a8edea; color: #333; }
        .badge-active { background: #28a745; color: white; }
        .badge-inactive { background: #6c757d; color: white; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; font-size: 14px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn:hover { opacity: 0.9; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group small { color: #666; font-size: 12px; }
        .message { padding: 10px; border-radius: 4px; margin-top: 10px; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.info { background: #d1ecf1; color: #0c5460; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 16px; }
        .tab.active { border-bottom: 3px solid #667eea; font-weight: bold; color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div id="nav"></div>
    
    <h1>üëë Admin Dashboard</h1>
    <p>System-wide administration and user management</p>
    
    <div class="stats-grid" id="statsGrid">
        <!-- Stats will be loaded here -->
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" id="tab-overview">üìä Overview</button>
        <button class="tab" id="tab-users">üë• User Management</button>
        <button class="tab" id="tab-projects">üìÅ Projects</button>
        <button class="tab" id="tab-reports">üìà Reports & Export</button>
    </div>
    
    <!-- Tab Content: Overview -->
    <div id="overview-tab" class="tab-content active">
        <div class="section">
            <h2>üìä System Overview</h2>
            <div id="systemOverview">
                <p>Loading system statistics...</p>
            </div>
        </div>
    </div>
    
    <!-- Tab Content: User Management -->
    <div id="users-tab" class="tab-content">
        <div class="section">
            <h2>üë• User Management</h2>
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button class="btn btn-success" id="createUserBtn">‚ûï Create New User</button>
                <select id="roleFilter">
                    <option value="">All Roles</option>
                    <option value="staff">Staff</option>
                    <option value="manager">Manager</option>
                    <option value="director">Director</option>
                    <option value="hr">HR</option>
                    <option value="admin">Admin</option>
                </select>
                <select id="statusFilter">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <table class="user-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>User ID</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="8">Loading users...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Content: Projects -->
    <div id="projects-tab" class="tab-content">
        <div class="section">
            <h2>üìÅ All Projects</h2>
            <div id="projectsList">Loading projects...</div>
        </div>
    </div>
    
    <!-- Tab Content: Reports & Export -->
    <div id="reports-tab" class="tab-content">
        <div class="section">
            <h2>üìà Reports & Export</h2>
            <p>Generate on-demand reports in PDF, CSV, or Excel format. Available to HR/Admin only.</p>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>üìã Task Completion Report</h3>
                <p>Generate comprehensive task completion reports with filters</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                    <!-- Report Type -->
                    <div class="form-group">
                        <label for="reportType">Report Type:</label>
                        <select id="reportType" class="form-control">
                            <option value="summary">Summary Report</option>
                            <option value="user">By User</option>
                            <option value="project">By Project</option>
                        </select>
                    </div>
                    
                    <!-- Format -->
                    <div class="form-group">
                        <label for="reportFormat">Export Format:</label>
                        <select id="reportFormat" class="form-control">
                            <option value="pdf">üìÑ PDF</option>
                            <option value="csv">üìä CSV</option>
                            <option value="xlsx">üìó Excel (XLSX)</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                    <!-- User Filter -->
                    <div class="form-group">
                        <label for="filterUserId">Filter by User (optional):</label>
                        <input type="text" id="filterUserId" placeholder="user_id" class="form-control">
                        <small>Leave blank for all users</small>
                    </div>
                    
                    <!-- Project Filter -->
                    <div class="form-group">
                        <label for="filterProjectId">Filter by Project (optional):</label>
                        <input type="text" id="filterProjectId" placeholder="project_id" class="form-control">
                        <small>Leave blank for all projects</small>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                    <!-- Date Range -->
                    <div class="form-group">
                        <label for="startDate">Start Date (Due Date):</label>
                        <input type="date" id="startDate" class="form-control">
                        <small>Filter tasks due on or after this date</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate">End Date (Due Date):</label>
                        <input type="date" id="endDate" class="form-control">
                        <small>Filter tasks due on or before this date</small>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="generateReportBtn" style="width: 100%; padding: 15px; font-size: 16px; margin-top: 10px;">
                    üì• Generate & Download Report
                </button>
                
                <div id="reportMessage" style="margin-top: 15px;"></div>
            </div>
            
            <!-- Quick Report Options -->
            <div style="margin-top: 30px;">
                <h3>‚ö° Quick Reports</h3>
                <p>Generate common reports with one click</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <button class="btn btn-success" onclick="quickReport('this_week')">
                        üìÖ This Week's Tasks
                    </button>
                    <button class="btn btn-success" onclick="quickReport('this_month')">
                        üìÜ This Month's Tasks
                    </button>
                    <button class="btn btn-success" onclick="quickReport('completed')">
                        ‚úÖ All Completed Tasks
                    </button>
                    <button class="btn btn-success" onclick="quickReport('overdue')">
                        ‚ö†Ô∏è Overdue Tasks
                    </button>
                </div>
            </div>
            
            <!-- Report Stats Preview -->
            <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px;">
                <h4>üí° Report Tips</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>PDF:</strong> Best for presentations and formal reports (limited to 50 tasks)</li>
                    <li><strong>CSV:</strong> Best for quick data analysis and spreadsheet import</li>
                    <li><strong>Excel (XLSX):</strong> Best for detailed analysis with formatted tables</li>
                    <li><strong>Date filters:</strong> Use due date range to focus on specific periods</li>
                    <li><strong>Filters:</strong> Combine user and project filters for targeted reports</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">&times;</span>
            <h2>‚ûï Create New User</h2>
            
            <form id="createUserForm">
                <div class="form-group">
                    <label for="user_id">User ID:</label>
                    <input type="text" id="user_id" required placeholder="unique-user-id">
                    <small>Unique identifier (e.g., emp001, john_doe)</small>
                </div>
                
                <div class="form-group">
                    <label for="name">Full Name:</label>
                    <input type="text" id="name" required placeholder="John Doe">
                </div>
                
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required placeholder="user@example.com">
                    <small>User will use this email to log in</small>
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required placeholder="At least 6 characters" minlength="6">
                    <small>Minimum 6 characters - share this with the user securely</small>
                </div>
                
                <div class="form-group">
                    <label for="role">Role:</label>
                    <select id="role" required>
                        <option value="staff">Staff</option>
                        <option value="manager">Manager</option>
                        <option value="director">Director</option>
                        <option value="hr">HR</option>
                        <option value="admin">Admin</option>
                    </select>
                    <small>Determines user permissions and dashboard access</small>
                </div>

                <div class="form-group">
                    <label for="department">Department:</label>
                    <select id="department">
                        <option value="">-- Select Department --</option>
                        <option value="Finance &amp; Accounting">Finance &amp; Accounting</option>
                        <option value="Operations">Operations</option>
                        <option value="Customer Service (Support)">Customer Service (Support)</option>
                        <option value="Sales &amp; Marketing">Sales &amp; Marketing</option>
                        <option value="Product Management">Product Management</option>
                        <option value="Quality Assurance (QA)">Quality Assurance (QA)</option>
                        <option value="IT / Data / Infrastructure">IT / Data / Infrastructure</option>
                        <option value="Legal &amp; Compliance">Legal &amp; Compliance</option>
                    </select>
                    <small>Optional: assign a department to the user</small>
                </div>
                
                <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 10px;">
                    Create User
                </button>
                
                <div id="createUserMessage"></div>
            </form>
        </div>
    </div>
    
    <!-- ‚úÖ Load firebase-auth.js FIRST (it defines API_BASE) -->
    <script src="firebase-auth.js"></script>
    
    <script>
        // ‚úÖ Require admin role
        const currentUser = requireAdmin();
        
        // ‚úÖ DON'T redeclare API_BASE - it's already in firebase-auth.js
        // const API_BASE = 'http://localhost:5000'; // ‚ùå REMOVED
        
        let allUsers = [];
        
        // ==================== TAB SWITCHING (Event Listeners) ====================
        
        document.getElementById('tab-overview').addEventListener('click', function() {
            switchTab('overview', this);
        });
        
        document.getElementById('tab-users').addEventListener('click', function() {
            switchTab('users', this);
        });
        
        document.getElementById('tab-projects').addEventListener('click', function() {
            switchTab('projects', this);
        });
        
        document.getElementById('tab-reports').addEventListener('click', function() {
            switchTab('reports', this);
        });
        
        function switchTab(tabName, tabElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            tabElement.classList.add('active');
            
            // Load data for tab
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'projects') {
                loadProjects();
            }
        }
        
        // ==================== DASHBOARD LOADING ====================
        
        async function loadAdminDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`);
                const data = await response.json();
                
                // Load statistics
                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="number">${data.statistics.total_users}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users</h3>
                        <div class="number">${data.statistics.active_users}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Tasks</h3>
                        <div class="number">${data.statistics.total_tasks}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Projects</h3>
                        <div class="number">${data.statistics.total_projects}</div>
                    </div>
                `;
                document.getElementById('statsGrid').innerHTML = statsHtml;
                
                // Load system overview
                const overviewHtml = `
                    <p><strong>Users by Role:</strong></p>
                    <ul>
                        <li>Staff: ${data.statistics.users_by_role.staff || 0}</li>
                        <li>Managers: ${data.statistics.users_by_role.manager || 0}</li>
                        <li>Directors: ${data.statistics.users_by_role.director || 0}</li>
                        <li>HR: ${data.statistics.users_by_role.hr || 0}</li>
                        <li>Admins: ${data.statistics.users_by_role.admin || 0}</li>
                    </ul>
                    <p><strong>Recent Activity:</strong></p>
                    <p>Tasks created today: ${data.statistics.tasks_created_today || 0}</p>
                `;
                document.getElementById('systemOverview').innerHTML = overviewHtml;
                
                // Store users for filtering
                allUsers = data.recent_users || [];
                displayUsers(allUsers);
                
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                alert('Failed to load admin dashboard');
            }
        }
        
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`);
                const data = await response.json();
                allUsers = data.recent_users || [];
                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td><code>${user.user_id || 'N/A'}</code></td>
                    <td>${user.department || 'N/A'}</td>
                    <td><span class="badge badge-${user.role || 'staff'}">${(user.role || 'staff').toUpperCase()}</span></td>
                    <td><span class="badge badge-${user.is_active !== false ? 'active' : 'inactive'}">${user.is_active !== false ? 'Active' : 'Inactive'}</span></td>
                    <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="changeUserRole('${user.user_id}')">Change Role</button>
                        <button class="btn btn-primary" onclick="changeUserDepartment('${user.user_id}')">Set Dept</button>
                        ${user.is_active !== false ? 
                            `<button class="btn btn-danger" onclick="deactivateUser('${user.user_id}')">Deactivate</button>` :
                            `<button class="btn btn-success" onclick="activateUser('${user.user_id}')">Activate</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }
        
        // ==================== USER FILTERING ====================
        
        document.getElementById('roleFilter').addEventListener('change', filterUsers);
        document.getElementById('statusFilter').addEventListener('change', filterUsers);
        
        function filterUsers() {
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = allUsers;
            
            if (roleFilter) {
                filtered = filtered.filter(u => u.role === roleFilter);
            }
            
            if (statusFilter === 'active') {
                filtered = filtered.filter(u => u.is_active !== false);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(u => u.is_active === false);
            }
            
            displayUsers(filtered);
        }
        
        // ==================== CREATE USER MODAL ====================
        
        document.getElementById('createUserBtn').addEventListener('click', openCreateUserModal);
        document.getElementById('closeModalBtn').addEventListener('click', closeCreateUserModal);
        
        function openCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserMessage').innerHTML = '';
        }
        
        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('createUserModal');
            if (event.target == modal) {
                closeCreateUserModal();
            }
        }
        
        // ==================== CREATE USER HANDLER ====================
        
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageDiv = document.getElementById('createUserMessage');
            messageDiv.innerHTML = '<p>Creating user...</p>';
            
            const userData = {
                user_id: document.getElementById('user_id').value.trim(),
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                manager_type: document.getElementById('role').value,  // For backend compatibility
                department: document.getElementById('department').value || ''
            };
            
            try {
                // Determine endpoint based on role
                const endpoint = userData.role === 'staff' ? 'staff' : 'managers';
                
                const response = await fetch(`${API_BASE}/api/admin/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    messageDiv.innerHTML = `
                        <div class="message success">
                            <p><strong>‚úÖ User Created Successfully!</strong></p>
                            <p>Send these credentials to the user:</p>
                            <p><strong>Email:</strong> ${result.user.email}</p>
                            <p><strong>Password:</strong> ${userData.password}</p>
                            <p><strong>Role:</strong> ${result.user.role}</p>
                            <p><strong>Department:</strong> ${result.user.department || userData.department || 'N/A'}</p>
                            <p><strong>Login URL:</strong> <a href="login.html" target="_blank">login.html</a></p>
                        </div>
                    `;
                    
                    // Reload users list
                    setTimeout(() => {
                        loadUsers();
                        closeCreateUserModal();
                    }, 3000);
                    
                } else {
                    messageDiv.innerHTML = `<div class="message error">‚ùå ${result.error}</div>`;
                }
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="message error">‚ùå Error: ${error.message}</div>`;
            }
        });
        
        // ==================== USER MANAGEMENT ACTIONS ====================
        
        async function changeUserRole(userId) {
            const newRole = prompt('Enter new role (staff, manager, director, hr, admin):');
            if (!newRole) return;
            
            const validRoles = ['staff', 'manager', 'director', 'hr', 'admin'];
            if (!validRoles.includes(newRole)) {
                alert('Invalid role. Must be: staff, manager, director, hr, or admin');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });
                
                if (response.ok) {
                    alert('Role updated successfully');
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('Failed: ' + error.error);
                }
            } catch (error) {
                alert('Error updating role');
            }
        }
        
        async function deactivateUser(userId) {
            if (!confirm('Deactivate this user? They will not be able to log in.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: false })
                });
                
                if (response.ok) {
                    alert('User deactivated');
                    loadUsers();
                } else {
                    alert('Failed to deactivate user');
                }
            } catch (error) {
                alert('Error deactivating user');
            }
        }
        
        async function activateUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: true })
                });
                
                if (response.ok) {
                    alert('User activated');
                    loadUsers();
                } else {
                    alert('Failed to activate user');
                }
            } catch (error) {
                alert('Error activating user');
            }
        }
        
        // ==================== PROJECTS ====================
        
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const projects = await response.json();
                
                const projectsHtml = projects.map(p => `
                    <div style="padding: 15px; border: 1px solid #eee; margin: 10px 0; border-radius: 4px; background: #f9f9f9;">
                        <h3>${p.name || p.project_id}</h3>
                        <p>${p.description || 'No description'}</p>
                        <p><strong>Project ID:</strong> <code>${p.project_id}</code></p>
                        <p><strong>Created:</strong> ${p.created_at ? new Date(p.created_at).toLocaleDateString() : 'N/A'}</p>
                    </div>
                `).join('');
                
                document.getElementById('projectsList').innerHTML = projectsHtml || 'No projects found';
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projectsList').innerHTML = 'Error loading projects';
            }
        }
        
        // ==================== PAGE INITIALIZATION ====================
        
        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadAdminDashboard);
        
        // ==================== REPORTS & EXPORT ====================
        
        document.getElementById('generateReportBtn').addEventListener('click', generateReport);
        
        async function generateReport() {
            const messageDiv = document.getElementById('reportMessage');
            messageDiv.innerHTML = '<div class="message info">‚è≥ Generating report...</div>';
            
            const reportType = document.getElementById('reportType').value;
            const format = document.getElementById('reportFormat').value;
            const userId = document.getElementById('filterUserId').value.trim();
            const projectId = document.getElementById('filterProjectId').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Build query parameters
            const params = new URLSearchParams({
                format: format,
                report_type: reportType
            });
            
            if (userId) params.append('user_id', userId);
            if (projectId) params.append('project_id', projectId);
            if (startDate) params.append('start_date', startDate + 'T00:00:00Z');
            if (endDate) params.append('end_date', endDate + 'T23:59:59Z');
            
            try {
                const response = await fetch(`${API_BASE}/api/reports/task-completion?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'X-User-Id': currentUser.uid
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    messageDiv.innerHTML = `<div class="message error">‚ùå ${error.error || 'Failed to generate report'}</div>`;
                    return;
                }
                
                // Get filename from Content-Disposition header or create default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `task_report_${new Date().getTime()}.${format}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) filename = filenameMatch[1];
                }
                
                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                messageDiv.innerHTML = `<div class="message success">‚úÖ Report downloaded successfully: ${filename}</div>`;
                
            } catch (error) {
                console.error('Error generating report:', error);
                messageDiv.innerHTML = `<div class="message error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Quick report functions
        function quickReport(type) {
            const messageDiv = document.getElementById('reportMessage');
            const today = new Date();
            let startDate = '';
            let endDate = '';
            
            // Calculate date ranges
            switch(type) {
                case 'this_week':
                    const monday = new Date(today);
                    monday.setDate(today.getDate() - today.getDay() + 1);
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);
                    startDate = monday.toISOString().split('T')[0];
                    endDate = sunday.toISOString().split('T')[0];
                    break;
                    
                case 'this_month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
                    
                case 'completed':
                    // Leave dates blank, will show all completed
                    break;
                    
                case 'overdue':
                    // Tasks due before today
                    endDate = new Date(today.setDate(today.getDate() - 1)).toISOString().split('T')[0];
                    break;
            }
            
            // Set form values
            document.getElementById('startDate').value = startDate;
            document.getElementById('endDate').value = endDate;
            document.getElementById('reportType').value = 'summary';
            document.getElementById('reportFormat').value = 'pdf';
            document.getElementById('filterUserId').value = '';
            document.getElementById('filterProjectId').value = '';
            
            // Show message
            messageDiv.innerHTML = `<div class="message info">üìã Quick report configured for: <strong>${type.replace('_', ' ')}</strong>. Click "Generate & Download Report" to export.</div>`;
        }

        // ==================== CHANGE DEPARTMENT ====================

        async function changeUserDepartment(userId) {
            // Allowed departments - must match backend
            const departments = [
                'Finance & Accounting',
                'Operations',
                'Customer Service (Support)',
                'Sales & Marketing',
                'Product Management',
                'Quality Assurance (QA)',
                'IT / Data / Infrastructure',
                'Legal & Compliance'
            ];

            // Show a prompt with options (admin must type exact value)
            const list = departments.map(d => `- ${d}`).join('\n');
            let newDept = prompt(`Enter new department for user ${userId}:\n(Enter empty to clear)\n\nAvailable departments:\n${list}`);
            if (newDept === null) return; // cancelled

            newDept = newDept.trim();

            if (newDept !== '' && !departments.includes(newDept)) {
                alert('Invalid department. Please enter one of the listed departments exactly.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/department`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-User-Id': currentUser.uid },
                    body: JSON.stringify({ department: newDept })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Department updated successfully');
                    loadUsers();
                } else {
                    alert('Failed to update department: ' + (result.error || JSON.stringify(result)));
                }
            } catch (err) {
                console.error('Error updating department:', err);
                alert('Error updating department');
            }
        }
    </script>
</body>
</html>
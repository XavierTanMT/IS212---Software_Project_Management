<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Attachments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Segoe UI, Arial;
      margin: 20px;
      max-width: 900px
    }

    form,
    .card {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0
    }

    input {
      padding: 8px;
      margin: 4px 0;
      width: 100%
    }

    button {
      padding: 8px 12px;
      cursor: pointer
    }

    .row>div {
      margin: 4px 0
    }

    .list>div {
      padding: 8px;
      border-bottom: 1px dashed #e3e3e3
    }
  </style>
</head>

<body>
  <div id="nav"></div>
  <script src="common.js"></script>
<script>try{requireAuth();}catch(e){}</script>

  <h1>Attachments</h1>
  <p id="task"></p>

  <div class="card">
    <h3>Add Attachment (metadata)</h3>
    <form id="addForm">
      <label>File Name</label>
      <input id="file_name" placeholder="design.pdf" required />
      <label>File Path (gs://bucket/key)</label>
      <input id="file_path" placeholder="gs://my-bucket/attachments/design.pdf" required />
      <label>Uploaded By</label>
      <input id="uploaded_by" placeholder="u123" />
      <button type="submit">Add</button>
    </form>
    <p><small>Note: This stores only metadata. Upload actual files to Firebase Storage and paste the gs:// path
        here.</small></p>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Attachment List</h3>
      <button id="refresh">Refresh</button>
    </div>
    <div id="list" class="list"></div>
  </div>


  <script>
    const API_BASE = "http://localhost:5000";
    // Using shared getCurrentUser from common.js catch (e) { return null; } }
    // Using shared setCurrentUser from common.js
    function q(s) { return document.querySelector(s); }
    function ce(t) { return document.createElement(t); }
    function fmtDate(d) { try { return new Date(d).toLocaleString(); } catch (e) { return d; } }
  </script>

  <script>
    var params = new URLSearchParams(location.search);
    var task_id = params.get("task_id");
    if (!task_id) { document.body.innerHTML = "<p>Missing ?task_id</p>"; throw new Error("no task_id"); }
    q("#task").innerText = "Task ID: " + task_id;

    async function addAttachment(e) {
      e.preventDefault();
      var payload = {
        task_id: task_id,
        file_name: q("#file_name").value.trim(),
        file_path: q("#file_path").value.trim(),
        uploaded_by: q("#uploaded_by").value.trim() || (getCurrentUser() ? getCurrentUser().user_id : "")
      };
      var res = await fetch(API_BASE + "/api/attachments", {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      var data = await res.json();
      if (!res.ok) { alert((data && data.error) || "Add failed"); return; }
      q("#addForm").reset();
      load();
    }

    async function load() {
      var res = await fetch(API_BASE + "/api/attachments/by-task/" + encodeURIComponent(task_id));
      var list = await res.json();
      var host = q("#list"); host.innerHTML = "";
      if (!Array.isArray(list) || !list.length) { host.innerHTML = "<p>No attachments</p>"; return; }
      list.forEach(function (a) {
        var row = ce("div");
        row.innerHTML = "<strong>" + (a.file_name || "") + "</strong> — " + (a.file_path || "") + "<br/><small>by " + (a.uploaded_by || "") + " • " + fmtDate(a.upload_date) + "</small>";
        host.appendChild(row);
      });
    }

    q("#addForm").addEventListener("submit", addAttachment);
    q("#refresh").addEventListener("click", load);
    load();
  </script>

<script>
// --- PATCH: generic empty-state guard --- //
(function(){
  if (window.__genericEmptyPatchApplied) return; window.__genericEmptyPatchApplied = true;
  function afterLoad(){
    document.querySelectorAll('.loading,.spinner').forEach(el=>el.remove());
    const empties = [
      ['#labelsList,.labels-list', 'No labels yet.'],
      ['#attachmentsList,.attachments-list', 'No attachments yet.'],
      ['#commentsList,.comments-list', 'No comments yet.'],
      ['#membersList,.members-list', 'No members yet.'],
    ];
    for (const [sel, text] of empties){
      const host = document.querySelector(sel);
      if (host && (host.children.length === 0 || host.innerHTML.trim() === '')){
        host.innerHTML = `<div style="padding:12px;color:#666">${text}</div>`;
      }
    }
  }
  window.addEventListener('load', ()=> setTimeout(afterLoad, 200));
})();
</script>

</body></html>
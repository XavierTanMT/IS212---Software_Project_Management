<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Task Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Segoe UI, Arial;
      margin: 20px;
      max-width: 900px
    }

    form,
    .card {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0
    }

    textarea,
    input {
      padding: 8px;
      margin: 4px 0;
      width: 100%
    }

    button {
      padding: 8px 12px;
      cursor: pointer;
      margin: 2px;
    }

    .btn-edit {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn-delete {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn-save {
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn-cancel {
      background-color: #9E9E9E;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .note {
      padding: 10px;
      border-bottom: 1px dashed #e3e3e3;
      position: relative;
    }

    .meta {
      color: #666;
      font-size: 12px;
      margin-top: 8px;
    }

    .mention {
      background-color: #E3F2FD;
      color: #1976D2;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: 500;
    }

    .actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .edit-form {
      margin-top: 8px;
    }

    .edit-form textarea {
      width: calc(100% - 20px);
      min-height: 60px;
    }

    .edited-badge {
      color: #999;
      font-style: italic;
      font-size: 11px;
    }

    .hint {
      color: #666;
      font-size: 12px;
      margin-top: 4px;
    }

    #loginStatus {
      font-size: 11px;
      margin-left: 8px;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .logged-in {
      background-color: #4CAF50;
      color: white;
    }

    .not-logged-in {
      background-color: #ff9800;
      color: white;
    }
  </style>
</head>

<body>
  <div id="nav"></div>
  <script src="common.js"></script>

  <h1>Task Notes</h1>
  <p id="task"></p>

  <div class="card">
    <h3>Add Note</h3>
    <form id="addForm">
      <label>Author ID <span id="loginStatus"></span></label>
      <input id="author_id" placeholder="u123" />
      <label>Note</label>
      <textarea id="body" rows="3" placeholder="Type your note... Use @username to mention teammates" required></textarea>
      <div class="hint">üí° Tip: Use @username to tag teammates</div>
      <button type="submit">Add</button>
    </form>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Notes</h3>
      <button id="refresh">Refresh</button>
    </div>
    <div id="list"></div>
  </div>


  <script>
    // Helper functions not in common.js
    function q(s) { return document.querySelector(s); }
    function ce(t) { return document.createElement(t); }
    function fmtDate(d) { try { return new Date(d).toLocaleString(); } catch (e) { return d; } }
    
    // Highlight @mentions in text
    function highlightMentions(text) {
      if (!text) return "";
      return text.replace(/@([a-zA-Z0-9_-]+)/g, '<span class="mention">@$1</span>');
    }
  </script>

  <script>
    var params = new URLSearchParams(location.search);
    var task_id = params.get("task_id");
    if (!task_id) { document.body.innerHTML = "<p>Missing ?task_id</p>"; throw new Error("no task_id"); }
    q("#task").innerText = "Task ID: " + task_id;

    var currentUserId = (getCurrentUser() && getCurrentUser().user_id) || "";

    async function addNote(e) {
      e.preventDefault();
      
      // Get author_id from form or current user
      var author_id = q("#author_id").value.trim() || currentUserId;
      var body = q("#body").value.trim();
      
      // Validate required fields
      if (!author_id) {
        alert("‚ö†Ô∏è Please log in or enter an Author ID to add a note.\n\nTo log in, go to the login page and sign in with your account.");
        return;
      }
      
      if (!body) {
        alert("‚ö†Ô∏è Please enter a note before submitting.");
        return;
      }
      
      var payload = {
        task_id: task_id,
        author_id: author_id,
        body: body
      };
      
      var res = await fetch(API_BASE + "/api/notes", {
        method: "POST", 
        headers: { 
          "Content-Type": "application/json",
          "X-User-Id": payload.author_id 
        }, 
        body: JSON.stringify(payload)
      });
      var data = await res.json();
      if (!res.ok) { 
        alert("‚ùå Failed to add note: " + (data && data.error) || "Unknown error"); 
        return; 
      }
      
      // Success!
      q("#addForm").reset();
      // Re-fill author_id after reset
      if (currentUserId) {
        q("#author_id").value = currentUserId;
      }
      load();
    }

    async function editNote(noteId, currentBody) {
      var noteDiv = document.querySelector(`[data-note-id="${noteId}"]`);
      if (!noteDiv) return;

      // Create edit form
      var editForm = ce("div");
      editForm.className = "edit-form";
      editForm.innerHTML = `
        <textarea id="edit-body-${noteId}" rows="3">${currentBody}</textarea>
        <div class="actions">
          <button class="btn-save" onclick="saveEdit('${noteId}')">Save</button>
          <button class="btn-cancel" onclick="cancelEdit('${noteId}')">Cancel</button>
        </div>
      `;

      // Hide original content and show edit form
      var bodyDiv = noteDiv.querySelector(".body");
      var actionsDiv = noteDiv.querySelector(".actions");
      bodyDiv.style.display = "none";
      actionsDiv.style.display = "none";
      noteDiv.appendChild(editForm);
    }

    async function saveEdit(noteId) {
      var newBody = q(`#edit-body-${noteId}`).value.trim();
      if (!newBody) {
        alert("Note cannot be empty");
        return;
      }

      var res = await fetch(API_BASE + "/api/notes/" + noteId, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "X-User-Id": currentUserId
        },
        body: JSON.stringify({ body: newBody })
      });

      var data = await res.json();
      if (!res.ok) {
        alert((data && data.error) || "Update failed");
        return;
      }

      load(); // Reload notes
    }

    function cancelEdit(noteId) {
      load(); // Just reload to restore original state
    }

    async function deleteNote(noteId) {
      if (!confirm("Are you sure you want to delete this note?")) return;

      var res = await fetch(API_BASE + "/api/notes/" + noteId, {
        method: "DELETE",
        headers: {
          "X-User-Id": currentUserId
        }
      });

      var data = await res.json();
      if (!res.ok) {
        alert((data && data.error) || "Delete failed");
        return;
      }

      load(); // Reload notes
    }

    // Make functions global for onclick handlers
    window.saveEdit = saveEdit;
    window.cancelEdit = cancelEdit;
    window.deleteNote = deleteNote;

    async function load() {
      var res = await fetch(API_BASE + "/api/notes/by-task/" + encodeURIComponent(task_id));
      var list = await res.json();
      var host = q("#list"); 
      host.innerHTML = "";
      
      if (!Array.isArray(list) || !list.length) { 
        host.innerHTML = "<p>No notes</p>"; 
        return; 
      }
      
      list.forEach(function (n) {
        var div = ce("div"); 
        div.className = "note";
        div.setAttribute("data-note-id", n.note_id);
        
        // Format body with highlighted mentions
        var bodyHtml = highlightMentions(n.body || "");
        
        // Format edited badge
        var editedBadge = n.edited_at ? '<span class="edited-badge">(edited)</span>' : '';
        
        // Format mentions count
        var mentionsInfo = '';
        if (n.mentions && n.mentions.length > 0) {
          mentionsInfo = `<span class="meta">üë• Mentioned: ${n.mentions.map(m => '@' + m).join(', ')}</span>`;
        }
        
        // Create body div
        var bodyDiv = ce("div");
        bodyDiv.className = "body";
        bodyDiv.innerHTML = bodyHtml;
        div.appendChild(bodyDiv);
        
        // Create meta div
        var metaDiv = ce("div");
        metaDiv.className = "meta";
        metaDiv.innerHTML = "by " + (n.author_id || "") + " ‚Ä¢ " + fmtDate(n.created_at) + " " + editedBadge;
        div.appendChild(metaDiv);
        
        // Add mentions info if exists
        if (mentionsInfo) {
          var mentionsDiv = ce("div");
          mentionsDiv.innerHTML = mentionsInfo;
          div.appendChild(mentionsDiv);
        }
        
        // Add edit/delete buttons only for current user's notes
        if (currentUserId && n.author_id === currentUserId) {
          var actionsDiv = ce("div");
          actionsDiv.className = "actions";
          actionsDiv.innerHTML = `
            <button class="btn-edit" onclick="editNote('${n.note_id}', \`${(n.body || '').replace(/`/g, '\\`')}\`)">Edit</button>
            <button class="btn-delete" onclick="deleteNote('${n.note_id}')">Delete</button>
          `;
          div.appendChild(actionsDiv);
        }
        
        host.appendChild(div);
      });
    }

    // Make editNote global
    window.editNote = editNote;

    q("#addForm").addEventListener("submit", addNote);
    q("#refresh").addEventListener("click", load);
    
    // Auto-fill author_id if user is logged in
    if (currentUserId) {
      q("#author_id").value = currentUserId;
      q("#loginStatus").textContent = "‚úì Logged in";
      q("#loginStatus").className = "logged-in";
    } else {
      q("#loginStatus").textContent = "‚ö† Not logged in";
      q("#loginStatus").className = "not-logged-in";
    }
    
    load();
  </script>
</body>

</html>
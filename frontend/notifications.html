<!-- Notifications fragment: reminder banner + scripts -->
<!-- This file is intended to be injected into pages that want the reminder banner. -->
<div id="reminderBannerContainer" style="position:relative;z-index:40"></div>

<script>
// Notifications: show tasks due today on login
async function fetchDueTodayReminders() {
    try {
        // Compute local day's UTC range and send as query params so server can match user's "today"
        const now = new Date();
        const localYear = now.getFullYear();
        const localMonth = now.getMonth(); // 0-based
        const localDate = now.getDate();

        const localStart = new Date(localYear, localMonth, localDate, 0, 0, 0);
        const localEnd = new Date(localYear, localMonth, localDate, 23, 59, 59, 999);
        // Convert local start/end to UTC ISO strings
        const start_iso = localStart.toISOString();
        const end_iso = localEnd.toISOString();

        const url = `${API_BASE}/api/notifications/due-today?start_iso=${encodeURIComponent(start_iso)}&end_iso=${encodeURIComponent(end_iso)}`;
        console.debug('Reminder request url:', url, 'start_iso', start_iso, 'end_iso', end_iso);
        const res = await fetch(url);
        console.debug('Reminder response status:', res.status);
        if (!res.ok) {
            console.warn('Reminder fetch returned non-OK', res.status);
            return null;
        }
        const payload = await res.json();
        console.debug('Reminder payload:', payload);
        return payload;
    } catch (e) {
        console.warn('Failed to fetch due-today reminders', e);
        return null;
    }
}

function renderReminderBanner(data) {
    const container = document.getElementById('reminderBannerContainer');
    if (!container) return;

    const hideKey = 'hideReminderUntil';
    const hideUntil = sessionStorage.getItem(hideKey);
    const today = new Date().toISOString().slice(0,10);

    // If user hid reminders for today, show a floating toggle button so they can unhide
    if (hideUntil === today) {
        container.innerHTML = '';
        showFloatingReminderToggle();
        return;
    }

    if (!data || !data.count || data.count === 0) {
        // No reminders to show â€” ensure floating toggle is removed
        removeFloatingReminderToggle();
        container.innerHTML = '';
        return;
    }

    // We have reminders â€” ensure floating toggle is hidden
    removeFloatingReminderToggle();

    const tasks = data.tasks || [];
    const plural = tasks.length > 1 ? 's' : '';
    let itemsHtml = '';
    for (const t of tasks.slice(0,5)) {
        itemsHtml += `<div style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.06)">${escapeHtml(t.title || 'Untitled')} â€” due ${escapeHtml(t.due_date || '')}</div>`;
    }

    const more = tasks.length > 5 ? `<div style="padding:6px 0;color:#666">And ${tasks.length-5} more...</div>` : '';

    container.innerHTML = `
        <div style="background:#fff3cd;border:1px solid #ffeeba;padding:12px 16px;border-radius:6px;margin:12px 0;display:flex;align-items:flex-start;gap:12px">
            <div style="font-size:1.5rem">ðŸ””</div>
            <div style="flex:1">
                <div style="font-weight:600;margin-bottom:6px">You have ${tasks.length} reminder${plural} due today</div>
                <div style="max-height:120px;overflow:auto">${itemsHtml}${more}</div>
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                    <button id="dismissReminderBtn" style="background:#fff;border:1px solid #ddd;padding:6px 10px;border-radius:4px;cursor:pointer">Dismiss for today</button>
                    <button id="viewAllRemindersBtn" style="background:#667eea;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer">View reminders</button>
                </div>
            </div>
        </div>
    `;

    const dismissBtn = document.getElementById('dismissReminderBtn');
    if (dismissBtn) {
        dismissBtn.addEventListener('click', () => {
            sessionStorage.setItem(hideKey, today);
            container.innerHTML = '';
            showFloatingReminderToggle();
        });
    }

    const viewAllBtn = document.getElementById('viewAllRemindersBtn');
    if (viewAllBtn) {
        viewAllBtn.addEventListener('click', () => {
            // navigate to notifications or dashboard timeline if available
            try { window.toggleView && window.toggleView('timeline'); } catch(e) {}
        });
    }
}

function showFloatingReminderToggle() {
    const id = 'showReminderBtn';
    if (document.getElementById(id)) return; // already present
    const btn = document.createElement('button');
    btn.id = id;
    btn.title = "Show today's reminders";
    btn.innerHTML = 'ðŸ””';
    btn.addEventListener('click', async () => {
        // Unhide for today
        sessionStorage.removeItem('hideReminderUntil');
        // Remove floating toggle
        removeFloatingReminderToggle();
        // Re-fetch reminders and render banner
        try {
            const data = await fetchDueTodayReminders();
            renderReminderBanner(data);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (e) { console.warn('Failed to refetch reminders', e); }
    });
    const header = document.querySelector('.header');
    const userInfo = header ? header.querySelector('.user-info') : null;
    if (userInfo) {
        const avatar = userInfo.querySelector('.user-avatar');
        if (avatar && avatar.parentNode) {
            avatar.parentNode.insertBefore(btn, avatar);
        } else {
            userInfo.appendChild(btn);
        }
    } else if (header) {
        header.appendChild(btn);
    } else {
        document.body.appendChild(btn);
    }
}

function removeFloatingReminderToggle() {
    const el = document.getElementById('showReminderBtn');
    if (el) el.remove();
}

function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/[&<>"'`]/g, function(s){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;', '"':'&quot;',"'":'&#39;', '`':'&#96;'})[s];
    });
}

// When the page loads, fetch and show reminders for logged-in user
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Ensure user is authenticated (requireAuth is safe to call)
        try { requireAuth(); } catch(e){ return; }
        const data = await fetchDueTodayReminders();
        renderReminderBanner(data);
    } catch (e) {
        console.warn('Reminder init failed', e);
    }
});
</script>

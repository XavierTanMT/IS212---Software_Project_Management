<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Labels</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Segoe UI, Arial;
      margin: 20px;
      max-width: 900px
    }

    form,
    .card {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0
    }

    input {
      padding: 8px;
      margin: 4px 0;
      width: 100%
    }

    button {
      padding: 8px 12px;
      cursor: pointer
    }

    .chip {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eee;
      margin: 4px
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap
    }

    .col {
      flex: 1 1 300px
    }
  </style>
</head>

<body>
  <div id="nav"></div>
  <script src="common.js"></script>

  <h1>Labels</h1>

  <div class="card">
    <h3>Create Label</h3>
    <form id="createLabelForm">
      <label>Name</label>
      <input id="name" placeholder="e.g., Backend" required />
      <label>Color (hex or name)</label>
      <input id="color" placeholder="#aabbcc or 'tomato'" />
      <button type="submit">Create</button>
    </form>
  </div>

  <div class="card">
    <h3>All Labels</h3>
    <div id="all"></div>
  </div>

  <div class="card">
    <h3>Assign / Unassign Label to a Task</h3>
    <div class="row">
      <div class="col">
        <label>Task ID</label>
        <input id="task_id" placeholder="task doc id" />
      </div>
      <div class="col">
        <label>Label ID</label>
        <input id="label_id" placeholder="label doc id" />
      </div>
    </div>
    <button id="assign">Assign</button>
    <button id="unassign">Unassign</button>
  </div>


  <script>
    const API_BASE = "http://localhost:5000";
    function getCurrentUser() { try { return JSON.parse(localStorage.getItem("currentUser") || "null"); } catch (e) { return null; } }
    function setCurrentUser(u) { localStorage.setItem("currentUser", JSON.stringify(u)); }
    function q(s) { return document.querySelector(s); }
    function ce(t) { return document.createElement(t); }
    function fmtDate(d) { try { return new Date(d).toLocaleString(); } catch (e) { return d; } }
  </script>

  <script>
    async function createLabel(e) {
      e.preventDefault();
      var payload = { name: q("#name").value.trim(), color: q("#color").value.trim() };
      var res = await fetch(API_BASE + "/api/labels", {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      var data = await res.json();
      if (!res.ok) { alert((data && data.error) || "Create failed"); return; }
      q("#createLabelForm").reset();
      load();
    }

    async function load() {
      var res = await fetch(API_BASE + "/api/labels");
      var list = await res.json();
      var host = q("#all"); host.innerHTML = "";
      if (!Array.isArray(list) || !list.length) { host.innerHTML = "<p>No labels</p>"; return; }
      list.forEach(function (l) {
        var chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = (l.name || "") + " (" + (l.label_id || "") + ")";
        if (l.color) { chip.style.background = l.color; }
        host.appendChild(chip);
      });
    }

    async function assign(kind) {
      var task_id = q("#task_id").value.trim();
      var label_id = q("#label_id").value.trim();
      if (!task_id || !label_id) { alert("Provide task_id and label_id"); return; }
      var url = kind === "assign" ? "/api/labels/assign" : "/api/labels/unassign";
      var res = await fetch(API_BASE + url, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ task_id: task_id, label_id: label_id })
      });
      var data = await res.json();
      if (!res.ok) { alert((data && data.error) || (kind + " failed")); return; }
      alert(kind + " ok");
    }

    q("#createLabelForm").addEventListener("submit", createLabel);
    q("#assign").addEventListener("click", function () { assign("assign"); });
    q("#unassign").addEventListener("click", function () { assign("unassign"); });
    load();
  </script>

<script>
// --- PATCH: generic empty-state guard --- //
(function(){
  if (window.__genericEmptyPatchApplied) return; window.__genericEmptyPatchApplied = true;
  function afterLoad(){
    document.querySelectorAll('.loading,.spinner').forEach(el=>el.remove());
    const empties = [
      ['#labelsList,.labels-list', 'No labels yet.'],
      ['#attachmentsList,.attachments-list', 'No attachments yet.'],
      ['#commentsList,.comments-list', 'No comments yet.'],
      ['#membersList,.members-list', 'No members yet.'],
    ];
    for (const [sel, text] of empties){
      const host = document.querySelector(sel);
      if (host && (host.children.length === 0 || host.innerHTML.trim() === '')){
        host.innerHTML = `<div style="padding:12px;color:#666">${text}</div>`;
      }
    }
  }
  window.addEventListener('load', ()=> setTimeout(afterLoad, 200));
})();
</script>

</body></html>